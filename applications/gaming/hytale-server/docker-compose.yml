---
# Hytale Server - Docker Compose 設定
# 參考: https://github.com/indifferentbroccoli/hytale-server-docker

services:
  hytale-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hytale-server
    hostname: hytale-server
    restart: unless-stopped

    # 環境變數
    environment:
      # 使用者權限設定
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}

      # 伺服器基本設定
      - SERVER_NAME=${SERVER_NAME:-hytale-server}
      - DEFAULT_PORT=${DEFAULT_PORT:-5520}
      - MAX_PLAYERS=${MAX_PLAYERS:-20}
      - VIEW_DISTANCE=${VIEW_DISTANCE:-12}
      - MAX_MEMORY=${MAX_MEMORY:-8G}

      # 認證設定
      - AUTH_MODE=${AUTH_MODE:-authenticated}
      - SESSION_TOKEN=${SESSION_TOKEN:-}
      - IDENTITY_TOKEN=${IDENTITY_TOKEN:-}
      - OWNER_UUID=${OWNER_UUID:-}

      # 進階設定
      - ENABLE_BACKUPS=${ENABLE_BACKUPS:-false}
      - BACKUP_FREQUENCY=${BACKUP_FREQUENCY:-30}
      - DISABLE_SENTRY=${DISABLE_SENTRY:-true}
      - USE_AOT_CACHE=${USE_AOT_CACHE:-true}
      - ACCEPT_EARLY_PLUGINS=${ACCEPT_EARLY_PLUGINS:-false}
      - DOWNLOAD_ON_START=${DOWNLOAD_ON_START:-true}

    # 埠號映射 (UDP 協定)
    ports:
      - "${HYTALE_PORT:-5520}:5520/udp"

    # 掛載目錄 (統一在 hytale-data 下管理)
    volumes:
      - ./hytale-data/server-files:/home/hytale/server-files
      - ./hytale-data/backups:/home/hytale/backups
      - ./hytale-data/machine-id:/home/hytale/.machine-id

    # 資源限制
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT:-8}'
          memory: ${MEMORY_LIMIT:-10G}
        reservations:
          cpus: '${CPU_RESERVATION:-4}'
          memory: ${MEMORY_RESERVATION:-4G}

    # 健康檢查
    healthcheck:
      test: ["CMD", "pgrep", "-f", "HytaleServer.jar"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5m

    # 日誌設定
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # 網路設定
    networks:
      - hytale-network

networks:
  hytale-network:
    driver: bridge
    name: hytale-network
