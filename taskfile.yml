version: '3'

dotenv:
  - .env

vars:
  ROOT_DIR:
    sh: pwd
  NETWORK_FILE: "{{.ROOT_DIR}}/docker-compose.network.yaml"

tasks:

  default:
    desc: é¡¯ç¤ºå¯ç”¨æŒ‡ä»¤å’Œæœå‹™ç‹€æ…‹
    cmds:
      - task: info

  info:
    desc: é¡¯ç¤ºæœå‹™è³‡è¨Š
    cmds:
      - echo "ğŸ‰ DevOps Compose å¯ç”¨æŒ‡ä»¤ï¼š"
      - echo ""
      - echo "æ ¸å¿ƒæœå‹™:"
      - echo "  â€¢ task start:core     - å•Ÿå‹•æ ¸å¿ƒæœå‹™ (Traefik + Registry)"
      - echo "  â€¢ task stop:core      - åœæ­¢æ ¸å¿ƒæœå‹™"
      - echo ""
      - echo "åŸºç¤è¨­æ–½å±¤:"
      - echo "  â€¢ task start:postgres - å•Ÿå‹• PostgreSQL"
      - echo "  â€¢ task start:redis    - å•Ÿå‹• Redis"
      - echo "  â€¢ task start:mysql    - å•Ÿå‹• MySQL"
      - echo ""
      - echo "é–‹ç™¼å±¤:"
      - echo "  â€¢ task start:gitlab   - å•Ÿå‹• GitLab"
      - echo "  â€¢ task start:jenkins  - å•Ÿå‹• Jenkins"
      - echo "  â€¢ task start:nexus    - å•Ÿå‹• Nexus"
      - echo "  â€¢ task start:trivy    - å•Ÿå‹• Trivy"
      - echo ""
      - echo "é€šç”¨æŒ‡ä»¤:"
      - echo "  â€¢ task start SERVICE  - å•Ÿå‹•æŒ‡å®šæœå‹™"
      - echo "  â€¢ task stop SERVICE   - åœæ­¢æŒ‡å®šæœå‹™"
      - echo "  â€¢ task status SERVICE - æŸ¥çœ‹æœå‹™ç‹€æ…‹"
      - echo ""
      - echo "æœå‹™ç®¡ç†:"
      - echo "  â€¢ task list           - åˆ—å‡ºæ‰€æœ‰å¯ç”¨æœå‹™"
      - echo "  â€¢ task search KEYWORD - æœå°‹æœå‹™"

  list:
    desc: åˆ—å‡ºæ‰€æœ‰å¯ç”¨æœå‹™
    cmds:
      - task: .list-services

  search:
    desc: æœå°‹æœå‹™
    cmds:
      - task: .search-services
        vars:
          KEYWORD: "{{.CLI_ARGS}}"

  # æ ¸å¿ƒæœå‹™
  start:core:
    desc: å•Ÿå‹•æ ¸å¿ƒåŸºç¤æœå‹™
    cmds:
      - ./scripts/start-core.sh

  stop:core:
    desc: åœæ­¢æ ¸å¿ƒåŸºç¤æœå‹™
    cmds:
      - ./scripts/stop-core.sh

  # åŸºç¤è¨­æ–½å±¤æœå‹™å¿«æ·æŒ‡ä»¤
  start:postgres:
    desc: å•Ÿå‹• PostgreSQL
    cmds:
      - task: start
        vars: { SERVICE: "infrastructure/storage/postgres" }

  start:redis:
    desc: å•Ÿå‹• Redis
    cmds:
      - task: start
        vars: { SERVICE: "infrastructure/storage/redis" }

  start:mysql:
    desc: å•Ÿå‹• MySQL
    cmds:
      - task: start
        vars: { SERVICE: "infrastructure/storage/mysql" }

  # é–‹ç™¼å±¤æœå‹™å¿«æ·æŒ‡ä»¤
  start:gitlab:
    desc: å•Ÿå‹• GitLab
    cmds:
      - task: start
        vars: { SERVICE: "development/scm/gitlab" }

  start:jenkins:
    desc: å•Ÿå‹• Jenkins
    cmds:
      - task: start
        vars: { SERVICE: "development/cicd/jenkins" }

  start:nexus:
    desc: å•Ÿå‹• Nexus
    cmds:
      - task: start
        vars: { SERVICE: "development/quality/nexus" }

  start:trivy:
    desc: å•Ÿå‹• Trivy
    cmds:
      - task: start
        vars: { SERVICE: "development/quality/trivy" }

  # é€šç”¨æœå‹™ç®¡ç†æŒ‡ä»¤
  start:
    desc: å•Ÿå‹•æŒ‡å®šæœå‹™
    cmds:
      - task: .service-cmd
        vars:
          SERVICE: "{{.SERVICE | default .CLI_ARGS}}"
          CMD: "up -d"

  stop:
    desc: åœæ­¢æŒ‡å®šæœå‹™
    cmds:
      - task: .service-cmd
        vars:
          SERVICE: "{{.SERVICE | default .CLI_ARGS}}"
          CMD: "stop"

  down:
    desc: å®Œå…¨åœæ­¢æŒ‡å®šæœå‹™ (åŒ…å«ç§»é™¤å®¹å™¨)
    cmds:
      - task: .service-cmd
        vars:
          SERVICE: "{{.SERVICE | default .CLI_ARGS}}"
          CMD: "down"

  restart:
    desc: é‡å•ŸæŒ‡å®šæœå‹™
    cmds:
      - task: .service-cmd
        vars:
          SERVICE: "{{.SERVICE | default .CLI_ARGS}}"
          CMD: "restart"

  status:
    desc: æŸ¥çœ‹æŒ‡å®šæœå‹™ç‹€æ…‹
    cmds:
      - task: .service-cmd
        vars:
          SERVICE: "{{.SERVICE | default .CLI_ARGS}}"
          CMD: "ps"

  logs:
    desc: æŸ¥çœ‹æŒ‡å®šæœå‹™æ—¥èªŒ
    cmds:
      - task: .service-cmd
        vars:
          SERVICE: "{{.SERVICE | default .CLI_ARGS}}"
          CMD: "logs -f"

  # å…§éƒ¨æŒ‡ä»¤
  .service-cmd:
    internal: true
    desc: åŸ·è¡Œæœå‹™ Docker Compose æŒ‡ä»¤
    vars:
      RESOLVED_SERVICE:
        sh: |
          SERVICE="{{.SERVICE}}"
          if [ -z "$SERVICE" ]; then
            echo "è«‹æŒ‡å®šæœå‹™åç¨±"
            exit 1
          fi

          # å¦‚æœæ˜¯å®Œæ•´è·¯å¾‘ï¼Œç›´æ¥ä½¿ç”¨
          if [ -f "{{.ROOT_DIR}}/$SERVICE/docker-compose.yml" ]; then
            echo "$SERVICE"
            exit 0
          fi

          # æœå°‹çŸ­åç¨±
          FOUND=$(find {{.ROOT_DIR}} -name "docker-compose.yml" -type f | grep -E "/$SERVICE/docker-compose.yml$" | head -1)
          if [ -n "$FOUND" ]; then
            echo "$FOUND" | sed 's|{{.ROOT_DIR}}/||' | sed 's|/docker-compose.yml||'
            exit 0
          fi

          # æ¨¡ç³Šæœå°‹ï¼ˆåŒ…å«è©²åç¨±çš„æœå‹™ï¼‰
          FOUND=$(find {{.ROOT_DIR}} -name "docker-compose.yml" -type f | grep -E "/[^/]*$SERVICE[^/]*/docker-compose.yml$" | head -1)
          if [ -n "$FOUND" ]; then
            echo "$FOUND" | sed 's|{{.ROOT_DIR}}/||' | sed 's|/docker-compose.yml||'
            exit 0
          fi

          echo "æ‰¾ä¸åˆ°æœå‹™: $SERVICE"
          exit 1
      SERVICE_DIR: "{{.ROOT_DIR}}/{{.RESOLVED_SERVICE}}"
      COMPOSE_FILE: "{{.SERVICE_DIR}}/docker-compose.yml"
    preconditions:
      - sh: test -n "{{.SERVICE}}"
        msg: "è«‹æŒ‡å®šæœå‹™åç¨±ï¼Œä¾‹å¦‚: task start nexus æˆ– task start infrastructure/storage/postgres"
      - sh: test -f "{{.COMPOSE_FILE}}"
        msg: "æ‰¾ä¸åˆ°æœå‹™é…ç½®æª”æ¡ˆ: {{.COMPOSE_FILE}}"
    cmds:
      - |
        echo "ğŸ” è§£ææœå‹™: {{.SERVICE}} â†’ {{.RESOLVED_SERVICE}}"
        if [ -f "{{.NETWORK_FILE}}" ]; then
          docker compose --project-directory "{{.SERVICE_DIR}}" -f "{{.NETWORK_FILE}}" -f "{{.SERVICE_DIR}}/docker-compose.yml" {{.CMD}}
        else
          docker compose --project-directory "{{.SERVICE_DIR}}" -f "{{.SERVICE_DIR}}/docker-compose.yml" {{.CMD}}
        fi

  .list-services:
    internal: true
    desc: åˆ—å‡ºæ‰€æœ‰å¯ç”¨æœå‹™
    cmds:
      - |
        echo "ğŸ“‹ å¯ç”¨æœå‹™åˆ—è¡¨ï¼š"
        echo ""
        echo "ğŸ“‚ æŒ‰åˆ†å±¤åˆ†é¡ï¼š"

        # æ ¸å¿ƒæœå‹™
        echo "ğŸ”§ æ ¸å¿ƒæœå‹™:"
        if [ -f "{{.ROOT_DIR}}/core/docker-compose.yml" ]; then
          echo "  â€¢ core (Traefik + Registry Mirror)"
        fi
        echo ""

        # åŸºç¤è¨­æ–½å±¤
        echo "ğŸ—ï¸ åŸºç¤è¨­æ–½å±¤:"
        find {{.ROOT_DIR}}/infrastructure -name "docker-compose.yml" -type f 2>/dev/null | while read file; do
          service_path=$(echo "$file" | sed 's|{{.ROOT_DIR}}/||' | sed 's|/docker-compose.yml||')
          service_name=$(basename "$service_path")
          echo "  â€¢ $service_name ($service_path)"
        done
        echo ""

        # å¹³å°å±¤
        echo "ğŸ”§ å¹³å°å±¤:"
        find {{.ROOT_DIR}}/platform -name "docker-compose.yml" -type f 2>/dev/null | while read file; do
          service_path=$(echo "$file" | sed 's|{{.ROOT_DIR}}/||' | sed 's|/docker-compose.yml||')
          service_name=$(basename "$service_path")
          echo "  â€¢ $service_name ($service_path)"
        done
        echo ""

        # é–‹ç™¼å±¤
        echo "ğŸ’» é–‹ç™¼å±¤:"
        find {{.ROOT_DIR}}/development -name "docker-compose.yml" -type f 2>/dev/null | while read file; do
          service_path=$(echo "$file" | sed 's|{{.ROOT_DIR}}/||' | sed 's|/docker-compose.yml||')
          service_name=$(basename "$service_path")
          echo "  â€¢ $service_name ($service_path)"
        done
        echo ""

        # æ‡‰ç”¨å±¤
        echo "ğŸš€ æ‡‰ç”¨å±¤:"
        find {{.ROOT_DIR}}/applications -name "docker-compose.yml" -type f 2>/dev/null | while read file; do
          service_path=$(echo "$file" | sed 's|{{.ROOT_DIR}}/||' | sed 's|/docker-compose.yml||')
          service_name=$(basename "$service_path")
          echo "  â€¢ $service_name ($service_path)"
        done
        echo ""

        echo "ğŸ’¡ ä½¿ç”¨æ–¹å¼ï¼š"
        echo "  â€¢ çŸ­åç¨±: task start nexus"
        echo "  â€¢ å®Œæ•´è·¯å¾‘: task start development/quality/nexus"

  .search-services:
    internal: true
    desc: æœå°‹æœå‹™
    vars:
      KEYWORD: "{{.KEYWORD}}"
    preconditions:
      - sh: test -n "{{.KEYWORD}}"
        msg: "è«‹æä¾›æœå°‹é—œéµå­—ï¼Œä¾‹å¦‚: task search nexus"
    cmds:
      - |
        echo "ğŸ” æœå°‹çµæœ: '{{.KEYWORD}}'"
        echo ""

        FOUND=0
        find {{.ROOT_DIR}} -name "docker-compose.yml" -type f | while read file; do
          service_path=$(echo "$file" | sed 's|{{.ROOT_DIR}}/||' | sed 's|/docker-compose.yml||')
          service_name=$(basename "$service_path")

          # æª¢æŸ¥æœå‹™åç¨±æˆ–è·¯å¾‘æ˜¯å¦åŒ…å«é—œéµå­—
          if echo "$service_name" | grep -qi "{{.KEYWORD}}" || echo "$service_path" | grep -qi "{{.KEYWORD}}"; then
            echo "âœ“ $service_name ($service_path)"
            FOUND=1
          fi
        done

        if [ $FOUND -eq 0 ]; then
          echo "âŒ æœªæ‰¾åˆ°åŒ…å« '{{.KEYWORD}}' çš„æœå‹™"
          echo ""
          echo "ğŸ’¡ æç¤º: ä½¿ç”¨ 'task list' æŸ¥çœ‹æ‰€æœ‰å¯ç”¨æœå‹™"
        else
          echo ""
          echo "ğŸ’¡ ä½¿ç”¨æ–¹å¼ï¼š"
          echo "  â€¢ task start <æœå‹™åç¨±>"
          echo "  â€¢ task status <æœå‹™åç¨±>"
        fi