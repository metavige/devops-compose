version: '3'

dotenv:
  - .env

vars:
  ROOT_DIR:
    sh: pwd
  NETWORK_FILE: "{{.ROOT_DIR}}/docker-compose.network.yaml"

tasks:

  default:
    desc: é¡¯ç¤ºå¯ç”¨æŒ‡ä»¤å’Œæœå‹™ç‹€æ…‹
    cmds:
      - task: info

  info:
    desc: é¡¯ç¤ºæœå‹™è³‡è¨Š
    cmds:
      - echo "ğŸ‰ DevOps Compose å¯ç”¨æŒ‡ä»¤ï¼š"
      - echo ""
      - echo "æ ¸å¿ƒæœå‹™:"
      - echo "  â€¢ task start:core     - å•Ÿå‹•æ ¸å¿ƒæœå‹™ (Traefik + Registry)"
      - echo "  â€¢ task stop:core      - åœæ­¢æ ¸å¿ƒæœå‹™"
      - echo ""
      - echo "åŸºç¤è¨­æ–½å±¤:"
      - echo "  â€¢ task start:postgres - å•Ÿå‹• PostgreSQL"
      - echo "  â€¢ task start:redis    - å•Ÿå‹• Redis"
      - echo "  â€¢ task start:mysql    - å•Ÿå‹• MySQL"
      - echo ""
      - echo "é–‹ç™¼å±¤:"
      - echo "  â€¢ task start:gitlab   - å•Ÿå‹• GitLab"
      - echo "  â€¢ task start:jenkins  - å•Ÿå‹• Jenkins"
      - echo "  â€¢ task start:nexus    - å•Ÿå‹• Nexus"
      - echo ""
      - echo "é€šç”¨æŒ‡ä»¤:"
      - echo "  â€¢ task start SERVICE  - å•Ÿå‹•æŒ‡å®šæœå‹™"
      - echo "  â€¢ task stop SERVICE   - åœæ­¢æŒ‡å®šæœå‹™"
      - echo "  â€¢ task status SERVICE - æŸ¥çœ‹æœå‹™ç‹€æ…‹"

  # æ ¸å¿ƒæœå‹™
  start:core:
    desc: å•Ÿå‹•æ ¸å¿ƒåŸºç¤æœå‹™
    cmds:
      - ./scripts/start-core.sh

  stop:core:
    desc: åœæ­¢æ ¸å¿ƒåŸºç¤æœå‹™
    cmds:
      - ./scripts/stop-core.sh

  # åŸºç¤è¨­æ–½å±¤æœå‹™å¿«æ·æŒ‡ä»¤
  start:postgres:
    desc: å•Ÿå‹• PostgreSQL
    cmds:
      - task: start
        vars: { SERVICE: "infrastructure/storage/postgres" }

  start:redis:
    desc: å•Ÿå‹• Redis
    cmds:
      - task: start
        vars: { SERVICE: "infrastructure/storage/redis" }

  start:mysql:
    desc: å•Ÿå‹• MySQL
    cmds:
      - task: start
        vars: { SERVICE: "infrastructure/storage/mysql" }

  # é–‹ç™¼å±¤æœå‹™å¿«æ·æŒ‡ä»¤
  start:gitlab:
    desc: å•Ÿå‹• GitLab
    cmds:
      - task: start
        vars: { SERVICE: "development/scm/gitlab" }

  start:jenkins:
    desc: å•Ÿå‹• Jenkins
    cmds:
      - task: start
        vars: { SERVICE: "development/cicd/jenkins" }

  start:nexus:
    desc: å•Ÿå‹• Nexus
    cmds:
      - task: start
        vars: { SERVICE: "development/quality/nexus" }

  # é€šç”¨æœå‹™ç®¡ç†æŒ‡ä»¤
  start:
    desc: å•Ÿå‹•æŒ‡å®šæœå‹™
    cmds:
      - task: .service-cmd
        vars:
          SERVICE: "{{.SERVICE | default .CLI_ARGS}}"
          CMD: "up -d"

  stop:
    desc: åœæ­¢æŒ‡å®šæœå‹™
    cmds:
      - task: .service-cmd
        vars:
          SERVICE: "{{.SERVICE | default .CLI_ARGS}}"
          CMD: "stop"

  down:
    desc: å®Œå…¨åœæ­¢æŒ‡å®šæœå‹™ (åŒ…å«ç§»é™¤å®¹å™¨)
    cmds:
      - task: .service-cmd
        vars:
          SERVICE: "{{.SERVICE | default .CLI_ARGS}}"
          CMD: "down"

  restart:
    desc: é‡å•ŸæŒ‡å®šæœå‹™
    cmds:
      - task: .service-cmd
        vars:
          SERVICE: "{{.SERVICE | default .CLI_ARGS}}"
          CMD: "restart"

  status:
    desc: æŸ¥çœ‹æŒ‡å®šæœå‹™ç‹€æ…‹
    cmds:
      - task: .service-cmd
        vars:
          SERVICE: "{{.SERVICE | default .CLI_ARGS}}"
          CMD: "ps"

  logs:
    desc: æŸ¥çœ‹æŒ‡å®šæœå‹™æ—¥èªŒ
    cmds:
      - task: .service-cmd
        vars:
          SERVICE: "{{.SERVICE | default .CLI_ARGS}}"
          CMD: "logs -f"

  # å…§éƒ¨æŒ‡ä»¤
  .service-cmd:
    internal: true
    desc: åŸ·è¡Œæœå‹™ Docker Compose æŒ‡ä»¤
    vars:
      SERVICE_DIR: "{{.ROOT_DIR}}/{{.SERVICE}}"
      COMPOSE_FILE: "{{.SERVICE_DIR}}/docker-compose.yml"
    preconditions:
      - sh: test -n "{{.SERVICE}}"
        msg: "è«‹æŒ‡å®šæœå‹™åç¨±ï¼Œä¾‹å¦‚: task start infrastructure/storage/postgres"
      - sh: test -f "{{.COMPOSE_FILE}}"
        msg: "æ‰¾ä¸åˆ°æœå‹™é…ç½®æª”æ¡ˆ: {{.COMPOSE_FILE}}"
    cmds:
      - |
        if [ -f "{{.NETWORK_FILE}}" ]; then
          docker compose --project-directory "{{.SERVICE_DIR}}" -f "{{.NETWORK_FILE}}" -f "{{.SERVICE_DIR}}/docker-compose.yml" {{.CMD}}
        else
          docker compose --project-directory "{{.SERVICE_DIR}}" -f "{{.SERVICE_DIR}}/docker-compose.yml" {{.CMD}}
        fi